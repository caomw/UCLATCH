/*******************************************************************
*   UCLATCH.h
*   UCLATCH
*
*	Author: Kareem Omar
*	kareem.omar@uah.edu
*	https://github.com/komrad36
*
*	Last updated Sep 12, 2016
*******************************************************************/
//
// Fastest implementation of an UPRIGHT (no rotation)
// LATCH 512-bit binary feature descriptor
// as described in the 2015 paper by
// Levi and Hassner:
//
// "LATCH: Learned Arrangements of Three Patch Codes"
// http://arxiv.org/abs/1501.03719
//
// See also the ECCV 2016 Descriptor Workshop paper, of which I am a coauthor:
//
// "The CUDA LATCH Binary Descriptor"
//
// Note once again that this is an UPRIGHT LATCH, a.k.a. ULATCH.
// A fast rotation- and scale-invariant version is in the works.
//
// This implementation is insanely fast, matching or beating
// the much simpler ORB descriptor despite outputting twice
// as many bits AND being a superior descriptor.
//
// A key insight responsible for much of the performance of
// this laboriously crafted CUDA kernel is due to
// Christopher Parker (https://github.com/csp256) to whom
// I am extremely grateful.
//
// CUDA CC 3.0 or higher is required.
//
// All functionality is contained in the files UCLATCH.h
// and UCLATCH.cu. 'main.cpp' is simply a sample test harness
// with example usage and performance testing.
//

#pragma once

#include "cuda_runtime.h"

#include <algorithm>
#include <cstdint>
#include <vector>

#ifdef __INTELLISENSE__
#define asm(x)
#include "device_launch_parameters.h"
#define __CUDACC__
#include "device_functions.h"
#undef __CUDACC__
#endif

void UCLATCH(const cudaTextureObject_t d_img_tex, const cudaTextureObject_t d_triplets, const cudaTextureObject_t d_kps, const int num_kps, uint64_t* const __restrict d_desc);

constexpr uint16_t triplets[2048] = {
	2403,3472,815,0,
	3481,1318,2981,0,
	2779,3423,1547,0,
	2458,3188,3826,0,
	1633,3058,1054,0,
	1350,894,2719,0,
	3492,1568,828,0,
	1917,3723,2071,0,
	2862,1761,2758,0,
	3627,3147,1178,0,
	1700,3800,916,0,
	1325,829,3714,0,
	2981,2247,963,0,
	2199,702,3789,0,
	3219,967,1703,0,
	2461,1686,4042,0,
	822,1029,2837,0,
	2935,2844,985,0,
	3648,690,2644,0,
	3914,1543,1334,0,
	1232,1343,1521,0,
	1424,1346,982,0,
	3039,1461,1091,0,
	2067,2915,3702,0,
	2102,1248,2678,0,
	1394,3489,3986,0,
	1738,1972,3761,0,
	3281,674,3426,0,
	3220,619,3929,0,
	2029,2695,2460,0,
	2600,1199,1957,0,
	3033,2685,3688,0,
	2693,3970,745,0,
	2465,3839,3755,0,
	3110,1632,2612,0,
	1834,1414,3782,0,
	3419,703,1693,0,
	2913,2047,2837,0,
	3466,3703,1488,0,
	1486,3281,3219,0,
	2501,1090,2567,0,
	2696,763,3640,0,
	2969,2565,1094,0,
	3044,2704,1019,0,
	3579,3632,1820,0,
	882,1833,2180,0,
	3440,755,2824,0,
	3255,1352,584,0,
	673,3052,3775,0,
	1392,3775,747,0,
	765,3504,1328,0,
	3190,1688,1175,0,
	3436,966,1275,0,
	3685,4014,2178,0,
	3464,2130,2256,0,
	1234,4010,3825,0,
	3065,689,629,0,
	951,692,1748,0,
	3579,1184,950,0,
	3829,3769,2538,0,
	2212,2344,1633,0,
	4049,2486,731,0,
	3182,3712,1304,0,
	2280,1171,1064,0,
	2287,1620,3940,0,
	1350,754,3144,0,
	954,1208,1895,0,
	1987,4064,1452,0,
	3505,2399,1274,0,
	1631,3464,3152,0,
	2557,1181,2196,0,
	3713,1025,975,0,
	2779,3915,1630,0,
	2112,4081,3541,0,
	3501,920,2057,0,
	1911,3144,2416,0,
	3995,3434,628,0,
	3438,3634,1604,0,
	3257,2995,2971,0,
	1678,3289,1387,0,
	3438,2829,1708,0,
	2354,3477,3145,0,
	1062,2101,1280,0,
	3798,3483,699,0,
	3365,1760,2463,0,
	2345,2554,3207,0,
	3639,2900,621,0,
	1539,1601,2962,0,
	4083,2788,1568,0,
	2758,2194,807,0,
	1131,3869,1421,0,
	2541,1956,1751,0,
	893,3985,1687,0,
	3845,1494,2551,0,
	2029,2122,3536,0,
	3040,2410,3757,0,
	3839,1092,3903,0,
	2822,3695,1964,0,
	2790,1840,3931,0,
	3032,1261,872,0,
	3786,2026,905,0,
	2744,1400,1233,0,
	918,4061,2715,0,
	690,1687,1984,0,
	1895,2359,3250,0,
	1823,1423,879,0,
	2860,3395,1998,0,
	4088,3896,1484,0,
	1416,3110,1913,0,
	1678,3418,3650,0,
	2534,4065,3752,0,
	2745,1450,2823,0,
	1021,3902,3270,0,
	4042,2916,2458,0,
	1479,3714,3868,0,
	1814,2915,2680,0,
	1308,1692,1743,0,
	1897,3612,2100,0,
	2624,1764,1778,0,
	1025,753,3039,0,
	3280,3581,2144,0,
	3070,614,1633,0,
	2890,1772,3974,0,
	1747,3653,3113,0,
	3580,2847,613,0,
	1465,3345,3569,0,
	3144,2168,3872,0,
	2994,3401,3509,0,
	2542,1558,2890,0,
	1422,2602,2566,0,
	3847,1351,1110,0,
	1848,673,2787,0,
	773,2753,2054,0,
	2851,823,2038,0,
	670,3990,2683,0,
	587,3146,2688,0,
	590,1207,3467,0,
	2760,1419,3969,0,
	656,3256,1543,0,
	1593,2420,2456,0,
	882,1546,4044,0,
	2047,772,962,0,
	2492,1197,2423,0,
	3283,3032,3872,0,
	1462,3064,4051,0,
	3079,1315,3072,0,
	3920,3755,3632,0,
	2864,2827,3722,0,
	598,872,1963,0,
	2067,3848,3509,0,
	1256,4051,2982,0,
	3692,2758,1178,0,
	2614,748,1746,0,
	1856,4046,2284,0,
	2858,2544,1567,0,
	1884,3549,963,0,
	2348,1545,1196,0,
	2286,2118,3896,0,
	3577,3553,1489,0,
	1882,3327,3122,0,
	1389,1684,1038,0,
	3464,1988,3256,0,
	3972,1631,1170,0,
	3293,2318,1484,0,
	3326,732,3182,0,
	3832,2123,1239,0,
	3428,983,2629,0,
	1775,3760,4009,0,
	3683,2199,2401,0,
	3250,3725,1595,0,
	2345,701,614,0,
	3248,3492,1376,0,
	1032,4007,3981,0,
	3074,3994,2783,0,
	1314,3006,3539,0,
	1475,2312,2118,0,
	3650,2831,3579,0,
	1564,2316,2635,0,
	1837,763,1994,0,
	665,3944,3615,0,
	1953,1313,3121,0,
	1829,3563,1396,0,
	987,4062,2425,0,
	826,3784,1483,0,
	3150,1319,2056,0,
	2461,1348,3970,0,
	1121,728,3569,0,
	830,2335,3628,0,
	1408,671,3284,0,
	2199,2683,1992,0,
	661,4001,2974,0,
	1113,632,2556,0,
	1986,2262,3428,0,
	3150,3782,1682,0,
	776,4000,1609,0,
	2915,1909,3346,0,
	1485,3118,3135,0,
	1416,1825,1493,0,
	1769,3646,1693,0,
	764,3270,3856,0,
	2267,2189,3694,0,
	1747,1983,1091,0,
	1344,748,3578,0,
	2493,2215,2708,0,
	2396,2980,2178,0,
	3903,1694,1388,0,
	2471,2286,1592,0,
	3330,2745,2107,0,
	1449,3207,3465,0,
	3770,3924,899,0,
	1261,3214,1403,0,
	771,1461,920,0,
	3569,3836,4080,0,
	1668,3478,810,0,
	889,3033,1756,0,
	2786,4050,3076,0,
	822,1188,2202,0,
	1454,3333,809,0,
	1846,1097,2210,0,
	3644,2335,2860,0,
	3331,3980,3615,0,
	1853,1251,1928,0,
	2409,3000,3627,0,
	2574,3628,2934,0,
	2974,2630,592,0,
	1045,1468,590,0,
	952,3626,3973,0,
	2067,1593,1423,0,
	2925,3698,1923,0,
	1120,2319,3932,0,
	3928,759,774,0,
	702,1093,3507,0,
	3200,3869,765,0,
	2533,1169,2396,0,
	607,3726,3271,0,
	2831,4078,2258,0,
	2102,741,1958,0,
	2971,3633,2855,0,
	3195,618,3944,0,
	1249,2552,4063,0,
	1205,1953,2931,0,
	3650,1172,1990,0,
	3684,2208,948,0,
	1380,3870,2097,0,
	987,4048,2863,0,
	2677,3775,3434,0,
	1557,2574,1352,0,
	1669,3214,3537,0,
	2258,766,1679,0,
	1059,3991,1595,0,
	2430,1489,694,0,
	1767,2912,3845,0,
	2504,1902,1496,0,
	3352,2122,2777,0,
	598,3629,1965,0,
	3188,1956,1897,0,
	807,1254,1239,0,
	1261,701,1481,0,
	3046,2634,2832,0,
	2647,3125,2633,0,
	823,3911,2027,0,
	2108,627,2321,0,
	2960,3552,1813,0,
	628,1528,3725,0,
	1339,3971,843,0,
	2863,3551,1924,0,
	3830,1107,3133,0,
	1181,1385,3107,0,
	2566,2478,1092,0,
	808,2139,3404,0,
	3797,1923,2269,0,
	3221,4001,1689,0,
	2849,2762,2358,0,
	828,2062,3655,0,
	602,1388,2961,0,
	3862,990,1694,0,
	3918,1176,3987,0,
	3701,3079,1037,0,
	3826,3207,1453,0,
	1895,631,2824,0,
	3849,3422,2134,0,
	3636,3054,3765,0,
	899,1423,4015,0,
	1483,3725,1780,0,
	2062,3934,1341,0,
	1486,2863,3858,0,
	898,1404,1555,0,
	1414,4072,1344,0,
	1751,2137,3835,0,
	3471,2340,4047,0,
	3610,593,2911,0,
	1600,3913,2682,0,
	609,1699,3055,0,
	2991,2036,3646,0,
	2141,695,1981,0,
	4080,1552,4010,0,
	1489,3271,3722,0,
	3182,1338,4050,0,
	3772,3195,3767,0,
	1776,891,1847,0,
	3032,1549,1888,0,
	1235,3356,1232,0,
	2789,1975,3723,0,
	3080,3212,1259,0,
	1378,2049,2607,0,
	1491,3336,702,0,
	2059,1607,2496,0,
	3824,816,3349,0,
	1558,1739,774,0,
	1953,1543,3291,0,
	1485,3637,612,0,
	3907,2986,3690,0,
	3933,3689,1121,0,
	2693,2196,1325,0,
	835,1258,2484,0,
	2247,3411,880,0,
	1847,896,2343,0,
	3198,991,1615,0,
	1037,3429,699,0,
	3035,2557,3613,0,
	1455,3713,4048,0,
	588,751,1664,0,
	1988,952,1922,0,
	668,2922,1536,0,
	3865,1392,3143,0,
	3355,704,2779,0,
	3935,687,3363,0,
	3628,2861,2694,0,
	3079,632,3066,0,
	4050,2548,2459,0,
	1906,2864,4070,0,
	1774,1240,3146,0,
	2315,3336,3972,0,
	3897,2851,3896,0,
	3711,2360,4001,0,
	1702,2834,700,0,
	2428,2993,3861,0,
	1533,3415,4001,0,
	2488,3047,3871,0,
	733,2196,3757,0,
	694,2428,4011,0,
	3932,3271,1025,0,
	3152,2763,3221,0,
	2707,3414,2852,0,
	1384,3066,3545,0,
	1958,2537,2893,0,
	1700,3788,1486,0,
	1027,1737,3250,0,
	1055,3610,3360,0,
	1695,2503,1204,0,
	663,2977,3968,0,
	761,1179,1549,0,
	3106,2181,3324,0,
	619,3640,1344,0,
	3217,2841,3626,0,
	972,2632,3639,0,
	3694,679,661,0,
	2695,3295,609,0,
	952,3862,733,0,
	2687,3465,2543,0,
	3140,3437,4005,0,
	1451,631,1091,0,
	810,3264,2259,0,
	3721,2072,2778,0,
	773,2168,1773,0,
	1927,1960,1277,0,
	1748,1918,2685,0,
	2979,689,4080,0,
	2924,3680,2502,0,
	3982,2552,770,0,
	877,3419,2756,0,
	2673,2139,3969,0,
	3080,4072,2124,0,
	688,2207,3783,0,
	2643,626,2791,0,
	3479,2169,2474,0,
	2274,3855,2852,0,
	3482,2698,2788,0,
	1339,2987,1468,0,
	765,3975,3427,0,
	3931,2625,2137,0,
	3146,1319,701,0,
	2111,3358,2610,0,
	2348,604,3509,0,
	1235,686,880,0,
	910,1378,2408,0,
	2343,1244,1557,0,
	3576,2264,3858,0,
	1054,4066,1967,0,
	1892,2935,2974,0,
	4080,1616,1170,0,
	3179,810,3249,0,
	587,2501,1235,0,
	2913,2931,693,0,
	960,614,2857,0,
	3032,3794,587,0,
	2339,3931,1468,0,
	2128,3565,3074,0,
	3611,770,1883,0,
	4055,1114,2619,0,
	2698,614,3853,0,
	1132,3464,2125,0,
	2686,750,1693,0,
	1469,2611,3971,0,
	4070,3280,1763,0,
	1909,3075,3931,0,
	1598,1057,3038,0,
	3580,2141,3653,0,
	2457,839,1597,0,
	1024,2502,3902,0,
	3706,1760,2845,0,
	2629,1307,2484,0,
	3688,3417,2642,0,
	1889,1038,1740,0,
	805,3049,680,0,
	3905,2841,2320,0,
	1492,3644,2430,0,
	2215,4006,2205,0,
	2269,1848,2987,0,
	1533,907,667,0,
	2458,689,2100,0,
	2554,4063,3721,0,
	2541,3777,3752,0,
	3185,1320,1524,0,
	1348,1320,3003,0,
	728,2999,2040,0,
	1854,4064,2120,0,
	1131,2391,3151,0,
	1016,3419,1816,0,
	2346,3982,2633,0,
	2993,898,695,0,
	984,2923,3999,0,
	1129,1026,1349,0,
	598,2491,3262,0,
	3440,2127,3126,0,
	3828,2642,1823,0,
	3051,1886,3105,0,
	2273,608,1485,0,
	2281,690,3417,0,
	2216,2040,3368,0,
	2750,608,698,0,
	1704,1021,2275,0,
	2096,3915,3393,0,
	1233,2984,3181,0,
	1619,3909,827,0,
	1253,875,3690,0,
	846,1552,3993,0,
	1103,1684,2182,0,
	3791,628,2561,0,
	1168,2355,805,0,
	3001,1484,3136,0,
	3219,2457,2348,0,
	1208,741,992,0,
	2210,2697,673,0,
	834,2431,1618,0,
	1559,2600,2424,0,
	1416,1884,3286,0,
	2780,1487,906,0,
	1953,3861,2390,0,
	2245,817,1233,0,
	1739,1823,1238,0,
	1112,1490,3054,0,
	3826,1326,3939,0,
	2432,3854,986,0,
	3214,2538,3575,0,
	1386,2693,3204,0,
	1556,1710,704,0,
	2984,907,2419,0,
	3500,2060,3002,0,
	1131,3126,3897,0,
	2063,3573,2142,0,
	2183,1339,1963,0,
	2053,3620,1486,0,
	2933,682,2893,0,
	1102,3200,3712,0,
	1058,826,3282,0,
	2637,965,2427,0,
	1595,2272,656,0,
	3002,3785,2561,0,
	597,698,2547,0,
	1385,3217,3685,0,
	1341,1259,693,0,
	1626,2169,3504,0,
	810,3681,1898,0,
	3843,1746,3126,0,
	2781,624,3359,0,
	803,2400,3343,0,
	987,2710,3857,0,
	1912,3182,2425,0,
	1525,1414,3971,0,
	1052,1109,1337,0,
	3500,1565,3723,0,
	3897,605,3790,0,
	1969,1053,662,0,
	1234,1031,3478,0,
	3627,3044,1180,0,
	1625,2753,3505,0,
	1920,1831,876,0,
	2240,2894,2179,0,
	768,3134,1490,0,
	3492,881,2769,0,
	4009,3418,2069,0,
	2573,3824,2925,0,
	2260,3708,1820,0,
	1483,829,1398,0,
	3757,2181,588,0,
	3787,2047,677,0,
	2491,2839,2206,0,
	3976,1759,1311,0,
	1277,3710,618,0,
	695,1916,3129,0,
	3541,2355,1742,0
};
